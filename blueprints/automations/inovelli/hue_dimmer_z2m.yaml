blueprint:
  name: Hue Paddle Dimming + Scene Cycling (Unified Z2M Event with Sync)
  description: >
    ðŸŽ¯ All-in-one automation for Inovelli Blue switches (Z2M/MQTT) and Hue Rooms/Zones

    âœ… Paddle tap â†’ On/Off  
    âœ… Paddle hold/release â†’ Smooth dimming  
    âœ… Side button (button 3) â†’ Cycle Hue scenes (forward/backward)  
    âœ… Configurable off LED color  
    âœ… Light turned on â†’ (optional) activate default scene  
    âœ… Sync switch and light state via derived input_boolean.sync_<room>  
    âœ… Configurable brightness step (percent)  

    **ðŸ”´ Z2M ONLY**: This blueprint requires an MQTT sensor per switch. See README for setup instructions.
    The MQTT sensor listens to your specific Z2M topic (e.g., `zigbee2mqtt/<device_name>/action`) and must be configured in your `configuration.yaml` before using this blueprint.

  domain: automation

  input:
    z2m_action_sensor:
      name: Z2M Action Sensor (MQTT)
      description: >
        Select the MQTT sensor entity that monitors your switch's Z2M actions.
        This sensor should subscribe to `zigbee2mqtt/<device_name>/action` topic.
        Example: `sensor.kitchen_switch_action`
      selector:
        entity:
          domain: sensor
          integration: mqtt

    mqtt_entity:
      name: Inovelli Switch Device
      selector:
        device:
          integration: mqtt
          manufacturer: Inovelli

    switch_entity:
      name: Inovelli Switch Entity (the light entity of the switch)
      selector:
        entity:
          domain: light
          integration: mqtt

    light_entity:
      name: Light Group (Hue Room or Zone)
      selector:
        entity:
          domain: light
          integration: hue

    dimming_script:
      name: Dimming Script
      selector:
        entity:
          domain: script

    switch_led_off_color:
      name: Switch LED Off Color
      default: "24"
      selector:
        number:
          min: 0
          max: 255
          step: 1

    brightness_step:
      name: Brightness Step (%)
      default: 10
      selector:
        number:
          min: 1
          max: 50
          step: 1
          unit_of_measurement: "%"

    default_scene_enabled:
      name: Enable Default Scene
      default: false
      selector:
        boolean:

    default_scene:
      name: Default Scene
      default: ""
      selector:
        text:

trigger:
  - platform: state
    entity_id: !input z2m_action_sensor
    to:
      - up_held
      - down_held
      - up_release
      - down_release
      - up_single
      - up_double
      - down_single
      - down_double
      - config_single
      - config_held
      - config_release
    id: z2m_action

  - platform: state
    entity_id: !input light_entity
    from: "off"
    to: "on"
    id: light_on_trigger

  - platform: state
    entity_id: !input light_entity
    from: "on"
    to: "off"
    id: light_off_trigger

  - platform: state
    entity_id: !input switch_entity
    id: switch_state_change

  - platform: state 
    entity_id: !input light_entity
    id: light_state_change

variables:
  mqtt_entity: !input mqtt_entity
  switch_entity: !input switch_entity
  z2m_action_sensor: !input z2m_action_sensor
  light_entity: !input light_entity
  room: "{{ light_entity.split('.')[1] }}"
  room_lower: "{{ room | lower }}"
  switch_led_off_color: !input switch_led_off_color
  dimmer_flag: "input_boolean.dimmer_{{ room_lower }}"
  sync_flag: "input_boolean.sync_{{ room_lower }}"
  scene_index: "input_number.scene_index_{{ room_lower }}"
  available_scenes: >
    {% set prefix = 'scene.' ~ room_lower ~ '_' %}
    {{ states.scene | map(attribute='entity_id') | select('search', prefix) | list | sort }}
  default_scene_enabled: !input default_scene_enabled
  default_scene: !input default_scene
  brightness_step: !input brightness_step
  action: "{{ trigger.to_state.state if trigger.id == 'z2m_action' else '' }}"
  direction: >
    {% if action == 'down_held' %}Down
    {% elif action == 'up_held' %}Up
    {% else %}unknown{% endif %}
  is_hold: "{{ action in ['up_held', 'down_held'] }}"
  is_release: "{{ action in ['up_release', 'down_release'] }}"
  is_up_double: "{{ action == 'up_double' }}"
  is_down_double: "{{ action == 'down_double' }}"
  is_button_3_press: "{{ action == 'config_single' }}"
  is_button_3_hold: "{{ action == 'config_held' }}"
  is_light_on_trigger: "{{ trigger.id == 'light_on_trigger' }}"
  is_light_off_trigger: "{{ trigger.id == 'light_off_trigger' }}"
  is_switch_state_change: "{{ trigger.id == 'switch_state_change' }}"
  is_light_state_change: "{{ trigger.id == 'light_state_change' }}"

action:
  - service: system_log.write
    data:
      level: debug
      message: "Z2M Action: action='{{ action }}' | hold={{ is_hold }} | direction={{ direction }} | button3_press={{ is_button_3_press }} | button3_hold={{ is_button_3_hold }}"

  - choose:
      - conditions: "{{ is_hold and direction in ['Up', 'Down'] }}"
        sequence:
          - service: input_boolean.turn_on
            target:
              entity_id: "{{ dimmer_flag }}"
          - service: script.turn_on
            target:
              entity_id: !input dimming_script
            data:
              variables:
                room: "{{ room }}"
                direction: "{{ direction }}"
                brightness_step: "{{ brightness_step }}"

      - conditions: "{{ is_release }}"
        sequence:
          - service: input_boolean.turn_off
            target:
              entity_id: "{{ dimmer_flag }}"

      - conditions: "{{ is_down_double }}"
        sequence:
          - service: light.turn_on
            target:
              entity_id: "{{ light_entity }}"
            data:
              brightness_pct: 10

      - conditions: "{{ is_up_double }}"
        sequence:
          - service: light.turn_on
            target:
              entity_id: "{{ light_entity }}"
            data:
              brightness_pct: 100

      # When light turns ON, sync switch and set LED
      - conditions: "{{ is_light_on_trigger }}"
        sequence:
          - service: input_boolean.turn_on
            target:
              entity_id: "{{ sync_flag }}"
          # Get color from light attributes
          - variables:
              room_color: >
                {% set s = states[light_entity] %}
                {% if 'hs_color' in s.attributes %}
                  # Map Hue value (0-360) directly to Inovelli range (0-255)
                  {{ (s.attributes.hs_color[0] / 360 * 255) | int }}
                {% else %}
                  # Default warm white
                  24
                {% endif %}
              led_intensity: "{{ ((states[light_entity].attributes.brightness | default(255) | float / 255) * 100) | round(0) | int }}"
          # Set LED color and intensity via MQTT for Z2M devices
          - service: mqtt.publish
            data:
              topic: "zigbee2mqtt/{{ mqtt_entity }}/set"
              payload: >
                {
                  "led_color_on": {{ room_color }},
                  "led_brightness_on": {{ led_intensity }}
                }
          # Optionally activate default scene
          - choose:
              - conditions: "{{ default_scene_enabled and default_scene != '' }}"
                sequence:
                  - service: scene.turn_on
                    target:
                      entity_id: "{{ default_scene }}"

      - conditions: "{{ is_light_off_trigger }}"
        sequence:
          - service: input_boolean.turn_off
            target:
              entity_id: "{{ sync_flag }}"
          # Add LED off color settings via MQTT
          - service: mqtt.publish
            data:
              topic: "zigbee2mqtt/{{ mqtt_entity }}/set"
              payload: >
                {
                  "led_color_off": {{ switch_led_off_color }},
                  "led_brightness_off": 1
                }

      - conditions: "{{ is_switch_state_change }}"
        sequence:
          - choose:
              - conditions: "{{ states(switch_entity) == 'on' }}"
                sequence:
                  - service: input_boolean.turn_on
                    target:
                      entity_id: "{{ sync_flag }}"
              - conditions: "{{ states(switch_entity) == 'off' }}"
                sequence:
                  - service: input_boolean.turn_off
                    target:
                      entity_id: "{{ sync_flag }}"

      - conditions: "{{ is_button_3_press }}"
        sequence:
          - choose:
              - conditions: "{{ available_scenes | length == 0 }}"
                sequence:
                  - service: system_log.write
                    data:
                      level: debug
                      message: "âŒ No scenes found for '{{ room_lower }}'"
              - conditions: "{{ states(scene_index) == 'unknown' }}"
                sequence:
                  - service: system_log.write
                    data:
                      level: debug
                      message: "âŒ Missing input_number: {{ scene_index }}"
              - conditions: []
                sequence:
                  - variables:
                      current: "{{ states(scene_index) | int(0) }}"
                      next: "{{ (current + 1) % (available_scenes | length) }}"
                      next_scene: "{{ available_scenes[next] }}"
                  - service: system_log.write
                    data:
                      level: debug
                      message: "ðŸ”„ FORWARD: current={{ current }} | next={{ next }} | max_scenes={{ available_scenes | length }} | next_scene={{ next_scene }}"
                  - service: input_number.set_value
                    data:
                      entity_id: "{{ scene_index }}"
                      value: "{{ next }}"
                  - wait_template: "{{ states(scene_index) | int(0) == next }}"
                    timeout: 
                      seconds: 2
                  - service: scene.turn_on
                    target:
                      entity_id: "{{ next_scene }}"
                  - service: system_log.write
                    data:
                      level: debug
                      message: "âœ… FORWARD COMPLETE: Activated {{ next_scene }}"

      - conditions: "{{ is_button_3_hold }}"
        sequence:
          - choose:
              - conditions: "{{ available_scenes | length == 0 }}"
                sequence:
                  - service: system_log.write
                    data:
                      level: debug
                      message: "âŒ No scenes found for '{{ room_lower }}'"
              - conditions: "{{ states(scene_index) == 'unknown' }}"
                sequence:
                  - service: system_log.write
                    data:
                      level: debug
                      message: "âŒ Missing input_number: {{ scene_index }}"
              - conditions: []
                sequence:
                  - variables:
                      current: "{{ states(scene_index) | int(0) }}"
                      prev: "{{ (current - 1) % (available_scenes | length) }}"
                      prev_scene: "{{ available_scenes[prev] }}"
                  - service: system_log.write
                    data:
                      level: debug
                      message: "ðŸ”„ BACKWARD: current={{ current }} | prev={{ prev }} | max_scenes={{ available_scenes | length }} | prev_scene={{ prev_scene }}"
                  - service: input_number.set_value
                    data:
                      entity_id: "{{ scene_index }}"
                      value: "{{ prev }}"
                  - wait_template: "{{ states(scene_index) | int(0) == prev }}"
                    timeout:
                      seconds: 2
                  - service: scene.turn_on
                    target:
                      entity_id: "{{ prev_scene }}"
                  - service: system_log.write
                    data:
                      level: debug
                      message: "âœ… BACKWARD COMPLETE: Activated {{ prev_scene }}"

      - conditions: "{{ is_light_state_change and states(light_entity) == 'on' }}"
        sequence:
          - variables:
              room_color: >
                {% set s = states[light_entity] %}
                {% if 'hs_color' in s.attributes %}
                  {{ (s.attributes.hs_color[0] / 360 * 255) | int }}
                {% else %}
                  24
                {% endif %}
              led_intensity: >
                {% set s = states[light_entity] %}
                {{ ((s.attributes.brightness | default(255)) / 255 * 100) | int }}
          - service: mqtt.publish
            data:
              topic: "zigbee2mqtt/{{ mqtt_entity }}/set"
              payload: >
                {
                  "led_color_on": {{ room_color }},
                  "led_brightness_on": {{ led_intensity }}
                }

  - choose:
      - conditions: "{{ states(sync_flag) == 'on' }}"
        sequence:
          - choose:
              - conditions: "{{ states(light_entity) != 'on' }}"
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id: "{{ light_entity }}"
          - choose:
              - conditions: "{{ states(switch_entity) != 'on' }}"
                sequence:
                  - service: light.turn_on
                    target:
                      entity_id: "{{ switch_entity }}"

      - conditions: "{{ states(sync_flag) == 'off' }}"
        sequence:
          - choose:
              - conditions: "{{ states(light_entity) != 'off' }}"
                sequence:
                  - service: light.turn_off
                    target:
                      entity_id: "{{ light_entity }}"
          - choose:
              - conditions: "{{ states(switch_entity) != 'off' }}"
                sequence:
                  - service: light.turn_off
                    target:
                      entity_id: "{{ switch_entity }}"

mode: restart
